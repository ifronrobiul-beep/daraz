<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KongShop - Online Shopping</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F5F5;
        }
        .flash-sale-timer {
            background: linear-gradient(90deg, #d53369 0%, #daae51 100%);
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #f97316;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #ea580c;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f97316;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-link.active {
            color: #f97316;
            border-bottom: 2px solid #f97316;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .admin-tab.active, .profile-tab.active {
            /* border-color: #f97316; */
            color: #f97316;
            /* background-color: #fff7ed; */
             font-weight: 600;
        }
         .profile-sidebar-link {
            display: block;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            color: #4b5563; /* text-gray-600 */
            transition: background-color 0.2s, color 0.2s;
         }
         .profile-sidebar-link:hover {
            background-color: #f3f4f6; /* bg-gray-100 */
         }
         .profile-sidebar-link.active {
            color: #f97316; /* text-orange-500 */
            font-weight: 600; /* font-semibold */
         }

        /* Star Rating Styles */
        .rating-input-group {
            display: inline-flex;
            flex-direction: row-reverse;
        }
        .rating-input-group input[type="radio"] {
            display: none;
        }
        .rating-input-group label {
            color: #ddd;
            cursor: pointer;
            font-size: 1.5rem;
            transition: color 0.2s;
        }
        .rating-input-group input[type="radio"]:checked ~ label,
        .rating-input-group label:hover,
        .rating-input-group label:hover ~ label {
            color: #f59e0b; /* amber-500 */
        }
        .prose p { margin-bottom: 1em; } /* Basic prose styling */

    </style>
</head>
<body class="bg-gray-100">

    <!-- App Container -->
    <div id="app" class="max-w-[1200px] mx-auto bg-white shadow-lg">

        <!-- Header -->
        <header class="bg-white sticky top-0 z-40 shadow-md">
            <!-- Top Bar -->
            <div class="bg-gray-100 text-xs text-gray-600 py-1 px-4 hidden md:block">
                <div class="max-w-7xl mx-auto flex justify-end items-center space-x-6">
                    <a href="#" class="hover:text-orange-500">Become a Seller</a>
                    <a href="#" class="hover:text-orange-500">Help & Support</a>
                </div>
            </div>

            <!-- Main Header -->
            <div class="py-4 px-4 md:px-8 flex items-center justify-between">
                <!-- Logo -->
                <div onclick="handleNavigation('home')" class="text-3xl font-bold text-orange-500 w-1/4 md:w-1/6 cursor-pointer">
                    KongShop
                </div>

                <!-- Search Bar -->
                <div class="flex-grow mx-4 relative">
                    <input type="text" id="search-input" onkeyup="handleSearch()" placeholder="Search in KongShop" class="w-full px-4 py-2 bg-gray-100 border-2 border-transparent rounded-full focus:outline-none focus:border-orange-500 transition-colors">
                    <button onclick="handleSearch(true)" class="absolute right-0 top-0 h-full px-4 bg-orange-500 text-white rounded-r-full flex items-center justify-center hover:bg-orange-600">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Actions -->
                <div id="header-actions" class="flex items-center space-x-4 md:space-x-6">
                    <!-- This content is now dynamic -->
                </div>
            </div>
            <!-- Navigation Bar -->
             <nav id="navbar" class="bg-white border-b px-4 md:px-8">
                <div class="flex items-center justify-center space-x-8 text-sm font-medium text-gray-600">
                    <a href="#" onclick="handleNavigation('home')" data-page="home" class="nav-link py-3 border-b-2 border-transparent hover:text-orange-500">Home</a>
                    <a href="#" onclick="handleNavigation('shop')" data-page="shop" class="nav-link py-3 border-b-2 border-transparent hover:text-orange-500">Shop</a>
                    <a href="#" onclick="handleNavigation('howToBuy')" data-page="howToBuy" class="nav-link py-3 border-b-2 border-transparent hover:text-orange-500">How to Buy</a>
                    <a href="#" onclick="handleNavigation('about')" data-page="about" class="nav-link py-3 border-b-2 border-transparent hover:text-orange-500">About Us</a>
                    <a href="#" onclick="handleNavigation('contact')" data-page="contact" class="nav-link py-3 border-b-2 border-transparent hover:text-orange-500">Contact</a>
                </div>
             </nav>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="p-4 md:p-6 min-h-[60vh]">
            <!-- Content will be dynamically injected here -->
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white pt-10 pb-6 px-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="font-bold text-lg mb-4 text-orange-400">Customer Care</h3>
                    <ul class="space-y-2 text-sm text-gray-300">
                        <li><a href="#" class="hover:text-white">Help Center</a></li>
                        <li><a href="#" onclick="handleNavigation('howToBuy')" class="hover:text-white">How to Buy</a></li>
                        <li><a href="#" onclick="handleNavigation('returns')" class="hover:text-white">Returns & Refunds</a></li>
                        <li><a href="#" onclick="handleNavigation('contact')" class="hover:text-white">Contact Us</a></li>
                        <li><a href="#" onclick="handleNavigation('privacy')" class="hover:text-white">Privacy Policy</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4 text-orange-400">KongShop</h3>
                    <ul class="space-y-2 text-sm text-gray-300">
                        <li><a href="#" onclick="handleNavigation('about')" class="hover:text-white">About Us</a></li>
                        <li><a href="#" class="hover:text-white">Careers</a></li>
                        <li><a href="#" onclick="handleNavigation('home')" class="hover:text-white">KongShop Blog</a></li> {/* Corrected link */}
                        <li><a href="#" onclick="handleNavigation('home')" class="hover:text-white">Terms & Conditions</a></li> {/* Corrected link */}
                    </ul>
                </div>
                <div class="col-span-1 md:col-span-2">
                     <h3 class="font-bold text-lg mb-4 text-orange-400">Payment Methods & Social</h3>
                     <div class="flex space-x-4 mb-4">
                        <img src="https://placehold.co/60x40/ffffff/000000?text=VISA" class="rounded" alt="Visa" onerror="this.onerror=null;this.src='https://placehold.co/60x40/ccc/000?text=Error';">
                        <img src="https://placehold.co/60x40/ffffff/000000?text=Mastercard" class="rounded" alt="Mastercard" onerror="this.onerror=null;this.src='https://placehold.co/60x40/ccc/000?text=Error';">
                        <img src="https://placehold.co/60x40/ffffff/000000?text=bKash" class="rounded" alt="bKash" onerror="this.onerror=null;this.src='https://placehold.co/60x40/ccc/000?text=Error';">
                     </div>
                     <div class="flex space-x-4">
                        <a href="#" class="text-gray-400 hover:text-white"><i data-lucide="facebook" class="w-6 h-6"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i data-lucide="instagram" class="w-6 h-6"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i data-lucide="twitter" class="w-6 h-6"></i></a>
                        <a href="#" class="text-gray-400 hover:text-white"><i data-lucide="youtube" class="w-6 h-6"></i></a>
                     </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-sm text-gray-400">
                &copy; <span id="footer-year"></span> KongShop. All Rights Reserved.
            </div>
        </footer>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-[120%] transition-transform duration-300 z-50">
        <!-- Toast message here -->
    </div>

    <!-- Modals -->
    <!-- Login Modal -->
    <div id="login-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Login</h2>
                <button onclick="hideModal('login-modal')" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="login-form" onsubmit="handleLogin(event)">
                 <div class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="login-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required>
                    </div>
                    <div class="relative">
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required>
                        <button type="button" onclick="togglePasswordVisibility('login-password')" class="absolute inset-y-0 right-0 top-6 pr-3 flex items-center text-sm leading-5">
                            <i class="h-5 w-5 text-gray-500" data-lucide="eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600">Login</button>
                 <p class="text-sm text-center mt-4 text-gray-600">
                    Don't have an account? <a href="#" onclick="showModal('signup-modal'); hideModal('login-modal');" class="font-medium text-orange-600 hover:text-orange-500">Sign up</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signup-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Create Account</h2>
                <button onclick="hideModal('signup-modal')" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="signup-form" onsubmit="handleSignup(event)">
                <div class="space-y-4">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="signup-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required>
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="signup-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required>
                    </div>
                    <div class="relative">
                        <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="signup-password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required>
                        <button type="button" onclick="togglePasswordVisibility('signup-password')" class="absolute inset-y-0 right-0 top-6 pr-3 flex items-center text-sm leading-5">
                            <i class="h-5 w-5 text-gray-500" data-lucide="eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600">Create Account</button>
                <p class="text-sm text-center mt-4 text-gray-600">
                    Already have an account? <a href="#" onclick="showModal('login-modal'); hideModal('signup-modal');" class="font-medium text-orange-600 hover:text-orange-500">Log in</a>
                </p>
            </form>
        </div>
    </div>
    
    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
             <div class="flex justify-between items-center mb-6">
                <h2 id="product-modal-title" class="text-2xl font-bold text-gray-800">Add New Product</h2>
                <button onclick="hideModal('product-modal')" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="product-form" onsubmit="handleSaveProduct(event)">
                <input type="hidden" id="product-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="product-name" class="block text-sm font-medium text-gray-700">Product Name</label><input type="text" id="product-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div>
                    <div><label for="product-category" class="block text-sm font-medium text-gray-700">Category</label><select id="product-category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></select></div>
                    <div><label for="product-price" class="block text-sm font-medium text-gray-700">Current Price (৳)</label><input type="number" id="product-price" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div>
                    <div><label for="product-discount-percent" class="block text-sm font-medium text-gray-700">Discount Percentage (%)</label><input type="number" id="product-discount-percent" step="0.1" min="0" max="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"></div>
                     <div><label for="product-quantity" class="block text-sm font-medium text-gray-700">Quantity (Stock)</label><input type="number" id="product-quantity" min="0" step="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div>
                     <div><label for="product-discount-text" class="block text-sm font-medium text-gray-700">Custom Discount Text (Overrides %)</label><input type="text" id="product-discount-text" placeholder="e.g., Sale, Special Offer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"></div>
                     <!-- Span makes image upload take full width -->
                    <div class="md:col-span-2"> 
                        <label for="product-image-upload" class="block text-sm font-medium text-gray-700">Product Image</label>
                        <div class="mt-1 flex items-center space-x-4">
                            <img id="product-image-preview" src="https://placehold.co/100x100/F5F5F5/CCC?text=Preview" class="w-24 h-24 object-cover rounded-md bg-gray-100">
                            <input type="file" id="product-image-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                        </div>
                        <input type="hidden" id="product-image">
                    </div>
                </div>
                 <div class="mt-8 text-right">
                    <button type="button" onclick="hideModal('product-modal')" class="mr-2 bg-gray-200 text-gray-800 py-2 px-6 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-orange-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-orange-600">Save Product</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 id="order-details-title" class="text-2xl font-bold text-gray-800">Order Details</h2>
                <button onclick="hideModal('order-details-modal')" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="order-details-content"></div>
        </div>
    </div>

     <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Edit Profile</h2>
                <button onclick="hideModal('edit-profile-modal')" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="profile-edit-form" onsubmit="handleUpdateProfile(event)">
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="profile-name-edit" value="" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div>
                    <div><label class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="profile-email-edit" value="" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm" disabled></div>
                     <div class="flex items-center">
                        <input id="profile-marketing-edit" type="checkbox" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                        <label for="profile-marketing-edit" class="ml-2 block text-sm text-gray-900">Receive marketing emails</label>
                    </div>
                </div>
                <div class="text-right mt-6">
                    <button type="button" onclick="hideModal('edit-profile-modal')" class="mr-2 bg-gray-200 text-gray-800 py-2 px-6 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-orange-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-orange-600">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

     <!-- Add/Edit Address Modal -->
     <div id="address-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 id="address-modal-title" class="text-2xl font-bold text-gray-800">Add New Address</h2>
                <button onclick="hideModal('address-modal')" class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <form id="address-form" onsubmit="handleSaveAddress(event)">
                <input type="hidden" id="address-type"> 
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="address-name" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="address-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div>
                    <div><label for="address-phone" class="block text-sm font-medium text-gray-700">Mobile Number</label><input type="tel" id="address-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div>
                    <div class="md:col-span-2"><label for="address-street" class="block text-sm font-medium text-gray-700">Address</label><input type="text" id="address-street" placeholder="House no./building/street/area" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div>
                    <div><label for="address-region" class="block text-sm font-medium text-gray-700">Region</label><select id="address-region" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"><option>Dhaka</option><option>Chittagong</option><option>Sylhet</option></select></div>
                    <div><label for="address-city" class="block text-sm font-medium text-gray-700">City</label><select id="address-city" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"><option>Dhaka</option><option>Gazipur</option><option>Narayanganj</option></select></div>
                    <div><label for="address-area" class="block text-sm font-medium text-gray-700">Area</label><select id="address-area" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"><option>Banani</option><option>Gulshan</option><option>Dhanmondi</option></select></div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Address Type</label>
                        <div class="mt-2 space-x-4">
                             <label class="inline-flex items-center"><input type="radio" name="label" value="Home" class="form-radio text-orange-600"> <span class="ml-2">Home</span></label>
                             <label class="inline-flex items-center"><input type="radio" name="label" value="Office" class="form-radio text-orange-600"> <span class="ml-2">Office</span></label>
                        </div>
                    </div>
                     <div class="md:col-span-2 flex items-center">
                        <input id="address-default-shipping" type="checkbox" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                        <label for="address-default-shipping" class="ml-2 block text-sm text-gray-900">Set as default shipping address</label>
                    </div>
                     <div class="md:col-span-2 flex items-center">
                        <input id="address-default-billing" type="checkbox" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                        <label for="address-default-billing" class="ml-2 block text-sm text-gray-900">Set as default billing address</label>
                    </div>
                </div>
                <div class="mt-8 text-right">
                    <button type="button" onclick="hideModal('address-modal')" class="mr-2 bg-gray-200 text-gray-800 py-2 px-6 rounded-lg font-semibold hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="bg-orange-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-orange-600">Save Address</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // --- REMOVED FIREBASE IMPORTS ---

        // --- STATE MANAGEMENT ---
        const state = {
            products: [], // Will be populated with mock data
            cart: [],
            orders: [], // Will be populated with mock data
            categories: ['Electronics', 'Fashion', 'Home & Kitchen', 'Health & Beauty'],
            currentPage: 'home',
            currentProduct: null,
            searchQuery: '',
            currentCategory: null,
            isLoggedIn: false,
            currentUser: null, // Will store mock user object {uid, displayName, email, isAdmin, profile}
            isAdmin: false,
            adminCurrentTab: 'dashboard',
            profileCurrentTab: 'manage', // Default to manage account view
            dashboardStats: { income: 0, pending: 0, completed: 0, canceled: 0 },
            bannerImageUrl: 'https://placehold.co/1200x400/FEF2F2/F97316?text=Biggest+Sale+of+The+Year!', // Default Banner
            pageContent: { // Content for static pages
                about: `<h2>About KongShop</h2><p>Welcome to KongShop, a project dedicated to demonstrating a modern e-commerce platform. Our mission is to provide an exceptional online shopping experience, offering a wide range of products from trusted sellers, all in one convenient place.</p><p>We believe in the power of technology to connect people and businesses, fostering a community of buyers and sellers built on trust and quality. This clone is built with modern web technologies to be fast, responsive, and user-friendly across all devices.</p><h3>Our Vision</h3><p>To be the number one e-commerce project demonstration, showcasing the potential of clean code, intuitive design, and robust functionality. We aim to inspire developers and provide a learning platform for building complex, single-page applications.</p>`,
                howToBuy: `<h2 class="text-center">How to Buy: 5 Easy Steps</h2><div class="mt-8 grid grid-cols-1 md:grid-cols-5 gap-8 text-center relative"><div class="hidden md:block absolute top-1/2 left-0 w-full h-0.5 bg-gray-200" style="transform: translateY(-50%); z-index: 0;"></div><div class="relative z-10 flex flex-col items-center"><div class="bg-orange-100 text-orange-600 rounded-full w-20 h-20 flex items-center justify-center border-4 border-white shadow"><i data-lucide="search" class="w-10 h-10"></i></div><h3 class="mt-4 font-bold">1. Find Your Product</h3><p class="text-sm text-gray-600">Use the search bar or browse categories to find what you're looking for.</p></div><div class="relative z-10 flex flex-col items-center"><div class="bg-orange-100 text-orange-600 rounded-full w-20 h-20 flex items-center justify-center border-4 border-white shadow"><i data-lucide="shopping-cart" class="w-10 h-10"></i></div><h3 class="mt-4 font-bold">2. Add to Cart</h3><p class="text-sm text-gray-600">On the product page, click the "Add to Cart" button.</p></div><div class="relative z-10 flex flex-col items-center"><div class="bg-orange-100 text-orange-600 rounded-full w-20 h-20 flex items-center justify-center border-4 border-white shadow"><i data-lucide="clipboard-list" class="w-10 h-10"></i></div><h3 class="mt-4 font-bold">3. Review & Checkout</h3><p class="text-sm text-gray-600">Review your items in the cart and click "Proceed to Checkout".</p></div><div class="relative z-10 flex flex-col items-center"><div class="bg-orange-100 text-orange-600 rounded-full w-20 h-20 flex items-center justify-center border-4 border-white shadow"><i data-lucide="credit-card" class="w-10 h-10"></i></div><h3 class="mt-4 font-bold">4. Place Your Order</h3><p class="text-sm text-gray-600">Enter your address, choose a payment method, and place your order.</p></div><div class="relative z-10 flex flex-col items-center"><div class="bg-orange-100 text-orange-600 rounded-full w-20 h-20 flex items-center justify-center border-4 border-white shadow"><i data-lucide="box" class="w-10 h-10"></i></div><h3 class="mt-4 font-bold">5. Receive Your Package</h3><p class="text-sm text-gray-600">Sit back and relax! Your order will be delivered to your doorstep.</p></div></div>`,
                contact: `<h2>Contact Us</h2><p>We'd love to hear from you! Whether you have a question about features, trials, or anything else, our team is ready to answer all your questions.</p><div class="mt-6 space-y-4"><p class="flex items-center"><i data-lucide="map-pin" class="w-5 h-5 mr-3 text-orange-500"></i>123 Commerce Way, Dhaka, Bangladesh</p><p class="flex items-center"><i data-lucide="phone" class="w-5 h-5 mr-3 text-orange-500"></i>+880 123 456 7890</p><p class="flex items-center"><i data-lucide="mail" class="w-5 h-5 mr-3 text-orange-500"></i>support@kongshop.com</p></div>`, // Simplified contact content
                privacy: `<h2>Privacy Policy</h2><p>Your privacy is important to us. It is KongShop's policy to respect your privacy regarding any information we may collect from you across our website.</p><p>We only ask for personal information when we truly need it to provide a service to you. We collect it by fair and lawful means, with your knowledge and consent. We also let you know why we’re collecting it and how it will be used.</p>`,
                returns: `<h2>Return & Refund Policy</h2><p>If you are not 100% satisfied with your purchase, you can return the product and get a full refund or exchange the product for another one, be it similar or not.</p><p>You can return a product for up to 30 days from the date you purchased it. Any product you return must be in the same condition you received it and in the original packaging. Please keep the receipt.</p>`,
            },
            editingPageKey: 'about', // Track which page is being edited in admin
        };
        
        // --- MOCK DATA (Restored & Updated) ---
        const mockProducts = [
             { id: 'prod1', name: 'Premium Wireless Earbuds', price: 2499, oldPrice: 3500, rating: 4.8, sold: 120, quantity: 50, image: 'https://placehold.co/400x400/F97316/FFFFFF?text=Earbuds', category: 'Electronics', discountText: '', reviews: [{user: 'Mehedi H.', rating: 5, text: 'Amazing sound quality and battery life!', date: new Date('2025-10-20'), userId: 'mock_mehedi@example.com'}, {user: 'Saima A.', rating: 4, text: 'Good product, connects easily.', date: new Date('2025-10-18'), userId: 'mock_saima@example.com'}], questions: [{user: 'Fahim', question: 'Is this compatible with iPhone?', answer: 'Yes, it works perfectly with all Bluetooth-enabled devices, including iPhones.', date: new Date('2025-10-19'), userId: 'mock_fahim@example.com'}] },
            { id: 'prod2', name: 'Smart Watch with Fitness Tracker', price: 3999, oldPrice: 5000, rating: 4.5, sold: 88, quantity: 30, image: 'https://placehold.co/400x400/3B82F6/FFFFFF?text=Watch', category: 'Electronics', discountText: '20% OFF', reviews: [], questions: [] }, 
            { id: 'prod3', name: 'Gaming Mouse with RGB', price: 1500, oldPrice: 2200, rating: 4.7, sold: 150, quantity: 100, image: 'https://placehold.co/400x400/EF4444/FFFFFF?text=Mouse', category: 'Electronics', discountText: '', reviews: [{user: 'GamerGuy', rating: 5, text: 'Best mouse for the price!', date: new Date('2025-09-15'), userId: 'mock_gamer@example.com'}], questions: [{user: 'Newbie', question: 'Can I change the RGB colors?', answer: 'Yes, it comes with software to customize the lighting effects.', date: new Date('2025-09-12'), userId: 'mock_newbie@example.com'}] },
            { id: 'prod4', name: '4K Action Camera', price: 8500, oldPrice: 11000, rating: 4.6, sold: 45, quantity: 25, image: 'https://placehold.co/400x400/22C55E/FFFFFF?text=Camera', category: 'Electronics', discountText: '', reviews: [], questions: [] },
            { id: 'prod5', name: 'Portable Bluetooth Speaker', price: 2200, oldPrice: 3000, rating: 4.9, sold: 200, quantity: 80, image: 'https://placehold.co/400x400/8B5CF6/FFFFFF?text=Speaker', category: 'Electronics', discountText: '', reviews: [], questions: [] },
            { id: 'prod6', name: 'Men\'s Casual Cotton Shirt', price: 850, oldPrice: 1200, rating: 4.2, sold: 250, quantity: 150, image: 'https://placehold.co/400x400/10B981/FFFFFF?text=Shirt', category: 'Fashion', discountText: '', reviews: [{user: 'Rina', rating: 5, text: 'Fabric is very comfortable.', date: new Date('2025-10-05'), userId: 'mock_rina@example.com'}], questions: [{user: 'Kamal', question: 'What is the return policy?', answer: 'We have a 7-day return policy for this item.', date: new Date('2025-10-06'), userId: 'mock_kamal@example.com'}] },
            { id: 'prod7', name: 'Women\'s Stylish Handbag', price: 1800, oldPrice: 2500, rating: 4.6, sold: 95, quantity: 60, image: 'https://placehold.co/400x400/EC4899/FFFFFF?text=Handbag', category: 'Fashion', discountText: '', reviews: [], questions: [] },
            { id: 'prod8', name: 'Leather Wallet for Men', price: 600, oldPrice: 900, rating: 4.4, sold: 400, quantity: 200, image: 'https://placehold.co/400x400/F59E0B/FFFFFF?text=Wallet', category: 'Fashion', discountText: '', reviews: [], questions: [] },
            { id: 'prod9', name: 'Classic Aviator Sunglasses', price: 1200, oldPrice: 1800, rating: 4.7, sold: 180, quantity: 75, image: 'https://placehold.co/400x400/06B6D4/FFFFFF?text=Sunglasses', category: 'Fashion', discountText: 'Sale', reviews: [], questions: [] }, 
            { id: 'prod10', name: 'Running Shoes for Men', price: 3200, oldPrice: 4500, rating: 4.5, sold: 130, quantity: 40, image: 'https://placehold.co/400x400/6366F1/FFFFFF?text=Shoes', category: 'Fashion', discountText: '', reviews: [], questions: [] },
            { id: 'prod11', name: 'Non-Stick Cookware Set (12 pcs)', price: 4500, oldPrice: 6000, rating: 4.9, sold: 50, quantity: 20, image: 'https://placehold.co/400x400/6366F1/FFFFFF?text=Cookware', category: 'Home & Kitchen', discountText: '', reviews: [], questions: [] },
            { id: 'prod12', name: 'Professional Blender 1500W', price: 5500, oldPrice: 7000, rating: 4.8, sold: 70, quantity: 35, image: 'https://placehold.co/400x400/8B5CF6/FFFFFF?text=Blender', category: 'Home & Kitchen', discountText: '', reviews: [], questions: [] },
            { id: 'prod13', name: 'Espresso Coffee Machine', price: 12500, oldPrice: 16000, rating: 4.9, sold: 30, quantity: 15, image: 'https://placehold.co/400x400/374151/FFFFFF?text=Coffee', category: 'Home & Kitchen', discountText: '', reviews: [], questions: [] },
            { id: 'prod14', name: 'Robotic Vacuum Cleaner', price: 18000, oldPrice: 25000, rating: 4.7, sold: 25, quantity: 10, image: 'https://placehold.co/400x400/F472B6/FFFFFF?text=Vacuum', category: 'Home & Kitchen', discountText: '', reviews: [], questions: [] },
            { id: 'prod15', name: 'Electric Toothbrush', price: 1800, oldPrice: 2500, rating: 4.8, sold: 90, quantity: 90, image: 'https://placehold.co/400x400/34D399/FFFFFF?text=Toothbrush', category: 'Health & Beauty', discountText: '', reviews: [], questions: [] },
            { id: 'prod16', name: 'Vitamin C Serum', price: 950, oldPrice: 1300, rating: 4.6, sold: 300, quantity: 120, image: 'https://placehold.co/400x400/FBBF24/FFFFFF?text=Serum', category: 'Health & Beauty', discountText: '', reviews: [], questions: [] },
        ];
         const mockOrders = [
            { id: 'order101', userId: 'mock_johndoe@example.com', customerName: 'johndoe', total: 3349, status: 'Pending', date: new Date('2025-10-21'), items: [{name: 'Premium Wireless Earbuds', quantity: 1, price: 2499}, {name: 'Men\'s Casual Cotton Shirt', quantity: 1, price: 850}] },
            { id: 'order102', userId: 'mock_janesmith@example.com', customerName: 'janesmith', total: 1800, status: 'Pending', date: new Date('2025-10-20'), items: [{name: 'Women\'s Stylish Handbag', quantity: 1, price: 1800}] },
            { id: 'order103', userId: 'mock_admin@kongshop.com', customerName: 'admin', total: 10700, status: 'Shipped', date: new Date('2025-10-19'), items: [{name: '4K Action Camera', quantity: 1, price: 8500}, {name: 'Portable Bluetooth Speaker', quantity: 1, price: 2200}] },
             { id: 'order104', userId: 'mock_ifronrobiul@gmail.com', customerName: 'ifronrobiul', total: 600, status: 'Completed', date: new Date('2025-10-18'), items: [{name: 'Leather Wallet for Men', quantity: 1, price: 600}] },
        ];


        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const toastElement = document.getElementById('toast');
        const searchInput = document.getElementById('search-input');
        const navbar = document.getElementById('navbar');
        const headerActions = document.getElementById('header-actions');

        // --- RENDER FUNCTIONS ---
        // (Keep all render functions as they primarily depend on the state object)
        function updateHeaderUI() {
            let actionsHTML = '';
            if(state.isLoggedIn) {
                 actionsHTML += `<a href="#" onclick="window.handleNavigation('profile')" class="hidden md:flex items-center space-x-2 text-gray-700 hover:text-orange-500">
                        <i data-lucide="user-circle" class="w-6 h-6"></i>
                        <span class="text-sm">My Account</span>
                    </a>`;
                 if (state.isAdmin) {
                     actionsHTML += `<a href="#" onclick="window.handleNavigation('admin')" class="hidden md:flex items-center space-x-2 text-orange-600 hover:text-orange-800 font-semibold">
                        <i data-lucide="shield" class="w-6 h-6"></i>
                        <span class="text-sm">Admin Panel</span>
                    </a>`;
                 }
                 actionsHTML += `<button onclick="window.handleLogout()" class="hidden md:flex items-center space-x-2 text-gray-700 hover:text-orange-500">
                        <i data-lucide="log-out" class="w-6 h-6"></i>
                        <span class="text-sm">Logout</span>
                    </button>`;
            } else {
                 actionsHTML = `
                    <a href="#" onclick="window.showModal('login-modal')" class="hidden md:flex items-center space-x-2 text-gray-700 hover:text-orange-500">
                        <i data-lucide="user" class="w-6 h-6"></i><span class="text-sm">Login</span>
                    </a>
                    <span class="text-gray-300 hidden md:block">|</span>
                    <a href="#" onclick="window.showModal('signup-modal')" class="hidden md:flex items-center space-x-2 text-gray-700 hover:text-orange-500">
                        <span class="text-sm">Sign Up</span>
                    </a>`;
            }
            actionsHTML += `<div onclick="window.handleNavigation('cart')" class="relative text-gray-700 hover:text-orange-500 cursor-pointer">
                <i data-lucide="shopping-cart" class="w-7 h-7"></i>
                <span id="cart-count" class="absolute -top-2 -right-2 bg-orange-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">${state.cart.reduce((sum, item) => sum + item.quantity, 0)}</span>
            </div>`;
            headerActions.innerHTML = actionsHTML;
            lucide.createIcons();
        }
        
        function renderLoader() { return `<div class="flex justify-center items-center p-20"><div class="loader"></div></div>`; }
        function renderProductGrid(products, title) {
            if (products.length === 0) { return `<section class="mb-8 text-center"><h2 class="text-2xl font-bold text-gray-800 mb-4">${title}</h2><p class="text-gray-500">No products found.</p></section>`; }
            
            let productsHTML = products.map(product => {
                let discountBadge = '';
                if (product.discountText) {
                    discountBadge = `<div class="absolute top-2 left-2 bg-orange-500 text-white text-xs px-2 py-1 rounded">${product.discountText}</div>`;
                } else if (product.oldPrice && product.oldPrice > product.price) {
                     const discountPercentage = Math.round(((product.oldPrice - product.price) / product.oldPrice) * 100);
                      if (discountPercentage > 0) { // Only show if there's a discount
                         discountBadge = `<div class="absolute top-2 left-2 bg-orange-500 text-white text-xs px-2 py-1 rounded">${discountPercentage}% OFF</div>`;
                     }
                }

                return `<div class="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-xl transition-shadow duration-300 group" onclick="window.handleNavigation('product', '${product.id}')">
                            <div class="relative">
                                <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x400/ccc/000?text=Image+Error';">
                                ${discountBadge}
                            </div>
                            <div class="p-4">
                                <h3 class="text-sm font-medium text-gray-800 truncate group-hover:text-orange-600">${product.name}</h3>
                                <div class="mt-2">
                                    <span class="text-lg font-bold text-orange-500">৳${product.price}</span>
                                    ${product.oldPrice && product.oldPrice > product.price ? `<span class="text-xs text-gray-500 line-through ml-2">৳${product.oldPrice.toFixed(0)}</span>` : ''}
                                </div>
                                <div class="flex items-center mt-2 text-xs text-gray-500">
                                    <div class="flex text-yellow-400">${'<i data-lucide="star" class="w-3 h-3 fill-current"></i>'.repeat(Math.floor(product.rating))}${(product.rating % 1 !== 0 ? '<i data-lucide="star-half" class="w-3 h-3 fill-current"></i>' : '')}</div>
                                    <span class="ml-1">(${product.sold})</span>
                                </div>
                            </div>
                        </div>`;
                }).join('');

            return `<section class="mb-8"><h2 class="text-2xl font-bold text-gray-800 mb-4">${title}</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">${productsHTML}</div></section>`;
        }
        function renderHomePage() {
            const flashSaleProducts = [...state.products].sort((a, b) => (b.oldPrice - b.price) - (a.oldPrice - a.price)).slice(0, 5);
            const justForYouProducts = [...state.products].sort(() => 0.5 - Math.random()).slice(0, 10);
            const homeHTML = `<section class="mb-8 rounded-lg overflow-hidden"><img src="${state.bannerImageUrl}" alt="Hero Banner" class="w-full" onerror="this.onerror=null;this.src='https://placehold.co/1200x400/ccc/000?text=Banner+Error';"></section><section class="mb-8 bg-white p-4 rounded-lg shadow"><h3 class="font-bold text-gray-700 mb-3">Categories</h3><div class="grid grid-cols-4 md:grid-cols-8 gap-4 text-center text-sm">${state.categories.map(cat => `<a href="#" onclick="window.handleNavigation('category', '${cat}')" class="flex flex-col items-center hover:text-orange-500"><div class="bg-gray-100 p-3 rounded-full mb-1"><i data-lucide="tag"></i></div>${cat}</a>`).join('')}</div></section>${renderProductGrid(flashSaleProducts, 'Flash Sale')}${renderProductGrid(justForYouProducts, 'Just For You')}`;
            mainContent.innerHTML = homeHTML;
            lucide.createIcons();
        }
        function renderShopPage() { mainContent.innerHTML = renderProductGrid(state.products, 'All Products'); lucide.createIcons(); }
        function renderFilteredProductsPage(title, products) { mainContent.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-lg"><button onclick="window.handleNavigation('home')" class="mb-4 text-orange-500 hover:text-orange-700 flex items-center"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back to Home</button>${renderProductGrid(products, title)}</div>`; lucide.createIcons(); }
        
        function renderProductDetailsPage() { 
            const productId = state.currentProduct;
            const product = state.products.find(p => p.id === productId);

            if (!product) { mainContent.innerHTML = `<p>Product not found.</p>`; return; } 

             // Display Stock Info
             let stockInfo = '';
             if (product.quantity > 10) {
                 stockInfo = `<span class="text-green-600 font-medium">In Stock</span>`;
             } else if (product.quantity > 0) {
                 stockInfo = `<span class="text-orange-600 font-medium">Only ${product.quantity} left!</span>`;
             } else {
                 stockInfo = `<span class="text-red-600 font-medium">Out of Stock</span>`;
             }


            // Reviews Section
            const reviewsHtml = product.reviews && product.reviews.length > 0 ? product.reviews.map(review => `
                <div class="border-t py-4">
                    <div class="flex items-center mb-1">
                        <div class="flex text-yellow-400">${'<i data-lucide="star" class="w-4 h-4 fill-current"></i>'.repeat(review.rating)}</div>
                        <span class="ml-2 font-semibold text-gray-800">${review.user}</span>
                    </div>
                    <p class="text-gray-600 text-sm">${review.text}</p>
                    <p class="text-xs text-gray-400 mt-1">${review.date.toLocaleDateString()}</p>
                </div>
            `).join('') : '<p class="text-gray-500 text-sm">No reviews yet.</p>';

            const reviewFormHtml = state.isLoggedIn ? `
                <form id="review-form" onsubmit="window.handlePostReview(event, '${product.id}')" class="mt-4">
                    <h4 class="font-semibold text-gray-800 mb-2">Write a Review</h4>
                    <div class="rating-input-group mb-2">
                        <input type="radio" id="star5" name="rating" value="5"><label for="star5">★</label>
                        <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>
                        <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>
                        <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>
                        <input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label>
                    </div>
                    <textarea id="review-text" rows="3" class="w-full p-2 border rounded-md" placeholder="Share your thoughts..." required></textarea>
                    <button type="submit" class="mt-2 bg-orange-500 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-orange-600">Post Review</button>
                </form>
            ` : `<p class="text-sm mt-4 text-gray-500">Please <a href="#" onclick="window.showModal('login-modal')" class="text-blue-500 hover:underline">log in</a> to write a review.</p>`;
            
            // Q&A Section
            const questionsHtml = product.questions && product.questions.length > 0 ? product.questions.map(q => `
                <div class="border-t py-3">
                    <p class="font-semibold text-gray-700"><span class="text-orange-500">Q:</span> ${q.question}</p>
                    <p class="text-gray-600 mt-1 pl-5"><span class="text-green-500">A:</span> ${q.answer || 'No answer yet.'}</p>
                    <p class="text-xs text-gray-400 mt-1 pl-5">Asked by ${q.user} on ${q.date.toLocaleDateString()}</p>
                </div>
            `).join('') : '<p class="text-gray-500 text-sm">No questions yet.</p>';

            const questionFormHtml = state.isLoggedIn ? `
                <form id="question-form" onsubmit="window.handlePostQuestion(event, '${product.id}')" class="mt-4">
                     <h4 class="font-semibold text-gray-800 mb-2">Ask a Question</h4>
                     <textarea id="question-text" rows="2" class="w-full p-2 border rounded-md" placeholder="Type your question here..." required></textarea>
                     <button type="submit" class="mt-2 bg-blue-500 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-blue-600">Ask Question</button>
                </form>
            ` : `<p class="text-sm mt-4 text-gray-500">Please <a href="#" onclick="window.showModal('login-modal')" class="text-blue-500 hover:underline">log in</a> to ask a question.</p>`;

            // "You Might Also Like" Section
            const relatedProducts = state.products.filter(p => p.category === product.category && p.id !== product.id).slice(0, 5);

            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <button onclick="history.back()" class="mb-4 text-orange-500 hover:text-orange-700 flex items-center"><i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i> Back</button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><img src="${product.image}" alt="${product.name}" class="w-full rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/400x400/ccc/000?text=Image+Error';"></div>
                        <div>
                            <h1 class="text-3xl font-bold text-gray-800">${product.name}</h1>
                            <div class="flex items-center mt-2 text-sm text-gray-500">
                                <div class="flex text-yellow-400">${'<i data-lucide="star" class="w-4 h-4 fill-current"></i>'.repeat(Math.floor(product.rating))}</div>
                                <span class="ml-2 text-blue-500 hover:underline cursor-pointer">${product.rating} Ratings</span>
                                <span class="mx-2">|</span>
                                <span class="text-blue-500 hover:underline cursor-pointer">${product.sold}+ Sold</span>
                                <span class="mx-2">|</span>
                                ${stockInfo} 
                            </div>
                            <div class="my-4">
                                <span class="text-4xl font-bold text-orange-500">৳${product.price}</span>
                                ${product.oldPrice && product.oldPrice > product.price ? `<span class="text-lg text-gray-400 line-through ml-3">৳${product.oldPrice.toFixed(0)}</span>` : ''}
                            </div>
                            <p class="text-gray-600 mb-6">This is a high-quality ${product.name.toLowerCase()} from the ${product.category} category. It's designed for durability and performance. Perfect for your daily needs. Limited stock available!</p>
                            <div class="flex items-center space-x-4">
                                <button onclick="window.handleAddToCart('${product.id}')" ${product.quantity === 0 ? 'disabled' : ''} class="flex-grow bg-orange-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-orange-600 transition-colors flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i data-lucide="shopping-cart" class="w-5 h-5"></i><span>Add to Cart</span>
                                </button>
                                <button onclick="window.handleBuyNow('${product.id}')" ${product.quantity === 0 ? 'disabled' : ''} class="flex-grow bg-blue-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Buy Now</button>
                            </div>
                             ${product.quantity === 0 ? '<p class="text-red-600 text-sm mt-2">Currently out of stock.</p>' : ''}
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-lg mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Ratings & Reviews</h3>
                    ${reviewsHtml}
                    ${reviewFormHtml}
                </div>
                 <div class="bg-white p-6 rounded-lg shadow-lg mt-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Questions About This Product</h3>
                    ${questionsHtml}
                    ${questionFormHtml}
                </div>
                <div class="mt-6">
                    ${renderProductGrid(relatedProducts, "You Might Also Like")}
                </div>
            `; 
            lucide.createIcons(); 
        }

        function renderCartPage() { if (state.cart.length === 0) { mainContent.innerHTML = `<div class="text-center bg-white p-10 rounded-lg shadow-lg"><i data-lucide="shopping-cart" class="w-24 h-24 mx-auto text-gray-300"></i><h2 class="text-2xl font-bold mt-4">Your cart is empty!</h2><p class="text-gray-500 mt-2">Looks like you haven't added anything to your cart yet.</p><button onclick="window.handleNavigation('shop')" class="mt-6 bg-orange-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-orange-600">Continue Shopping</button></div>`; lucide.createIcons(); return; } const cartItemsHTML = state.cart.map(item => `<div class="flex items-center justify-between p-4 border-b"><div class="flex items-center space-x-4"><img src="${item.image}" alt="${item.name}" class="w-20 h-20 object-cover rounded" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ccc/000?text=Error';"><div><h4 class="font-semibold">${item.name}</h4><p class="text-sm text-gray-500">${item.category}</p><button onclick="window.handleRemoveFromCart('${item.id}')" class="text-xs text-red-500 hover:underline mt-1">Remove</button></div></div><div class="text-lg font-semibold text-orange-500">৳${(item.price * item.quantity).toFixed(2)}</div><div class="flex items-center border rounded"><button onclick="window.handleQuantityChange('${item.id}', ${item.quantity - 1})" class="px-2 py-1 text-gray-600 hover:bg-gray-100">-</button><span class="px-4">${item.quantity}</span><button onclick="window.handleQuantityChange('${item.id}', ${item.quantity + 1})" class="px-2 py-1 text-gray-600 hover:bg-gray-100">+</button></div></div>`).join(''); const subtotal = state.cart.reduce((total, item) => total + (item.price * item.quantity), 0); const shipping = 50; const total = subtotal + shipping; mainContent.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-6">Shopping Cart</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2">${cartItemsHTML}</div><div class="bg-gray-50 p-6 rounded-lg"><h3 class="text-xl font-bold mb-4">Order Summary</h3><div class="space-y-2"><div class="flex justify-between"><span>Subtotal</span><span>৳${subtotal.toFixed(2)}</span></div><div class="flex justify-between"><span>Shipping</span><span>৳${shipping.toFixed(2)}</span></div><div class="border-t my-2"></div><div class="flex justify-between font-bold text-lg"><span>Total</span><span>৳${total.toFixed(2)}</span></div></div><button onclick="window.handleNavigation('checkout')" class="w-full mt-6 bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600">Proceed to Checkout</button></div></div></div>`; }
        function renderCheckoutPage() { mainContent.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-lg max-w-2xl mx-auto"><h2 class="text-3xl font-bold mb-6">Checkout</h2><form id="checkout-form" onsubmit="window.handlePlaceOrder(event)"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="md:col-span-2"><label for="name" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="name" value="${state.currentUser ? state.currentUser.displayName : ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div><div class="md:col-span-2"><label for="address" class="block text-sm font-medium text-gray-700">Shipping Address</label><input type="text" id="address" value="${state.currentUser.profile?.address || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div><div><label for="city" class="block text-sm font-medium text-gray-700">City</label><input type="text" id="city" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div><div><label for="phone" class="block text-sm font-medium text-gray-700">Phone Number</label><input type="tel" id="phone" value="${state.currentUser.profile?.phone || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div></div><div class="mt-6 border-t pt-6"><h3 class="text-xl font-bold mb-4">Payment Method</h3><div class="space-y-4"><div class="flex items-center"><input type="radio" name="payment" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500" checked><label class="ml-3">Cash on Delivery</label></div><div class="flex items-center"><input type="radio" name="payment" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500"><label class="ml-3">Credit/Debit Card</label></div><div class="flex items-center"><input type="radio" name="payment" class="h-4 w-4 text-orange-600 border-gray-300 focus:ring-orange-500"><label class="ml-3">Mobile Banking</label></div></div></div><div class="mt-8 text-right"><button type="submit" class="bg-orange-500 text-white py-3 px-8 rounded-lg font-semibold hover:bg-orange-600">Place Order</button></div></form></div>`; }
        function renderOrderConfirmationPage() { mainContent.innerHTML = `<div class="text-center bg-white p-10 rounded-lg shadow-lg"><i data-lucide="check-circle" class="w-24 h-24 mx-auto text-green-500"></i><h2 class="text-3xl font-bold mt-4">Order Placed Successfully!</h2><p class="text-gray-500 mt-2">Thank you for your purchase. You can check your order history in your profile.</p><button onclick="window.handleNavigation('home')" class="mt-8 bg-orange-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-orange-600">Continue Shopping</button></div>`; lucide.createIcons(); }
        
        function renderAboutUsPage() { mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-lg prose max-w-none">${state.pageContent.about}</div>`; }
        function renderHowToBuyPage() { mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-lg prose max-w-none">${state.pageContent.howToBuy}</div>`; lucide.createIcons(); }
        function renderContactPage() { 
            mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                     <div class="prose max-w-none">${state.pageContent.contact}</div>
                     <div>
                          <form onsubmit="event.preventDefault(); showToast('Message sent (simulation)!');">
                              <div class="space-y-4">
                                  <div><label for="contact-name" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="contact-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"></div>
                                  <div><label for="contact-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="contact-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"></div>
                                  <div><label for="contact-message" class="block text-sm font-medium text-gray-700">Message</label><textarea id="contact-message" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"></textarea></div>
                                  <div class="text-right"><button type="submit" class="bg-orange-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-orange-600">Send Message</button></div>
                              </div>
                          </form>
                     </div>
                </div>
            </div>`; 
            lucide.createIcons(); 
        }
        function renderPolicyPage(pageKey, title) { 
            mainContent.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-lg prose max-w-none"><h2>${title}</h2>${state.pageContent[pageKey]}</div>`; 
        }
        
        // --- ADMIN RENDER FUNCTIONS ---
        function renderAdminPanel() { 
            let content = ''; 
            switch(state.adminCurrentTab) { 
                case 'dashboard': content = renderAdminDashboard(); break;
                case 'orders': content = renderAdminOrders(); break; 
                case 'products': content = renderAdminProducts(); break; 
                case 'categories': content = renderAdminCategories(); break; 
                case 'content': content = renderAdminSiteContent(); break; // New Case
            } 
            mainContent.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-lg"><h2 class="text-3xl font-bold mb-4">Admin Panel</h2><div class="border-b border-gray-200"><nav class="-mb-px flex space-x-6 overflow-x-auto pb-px" aria-label="Tabs">
            <button onclick="window.setAdminTab('dashboard')" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${state.adminCurrentTab === 'dashboard' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">Dashboard</button>
            <button onclick="window.setAdminTab('orders')" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${state.adminCurrentTab === 'orders' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">Orders</button>
            <button onclick="window.setAdminTab('products')" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${state.adminCurrentTab === 'products' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">Products</button>
            <button onclick="window.setAdminTab('categories')" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${state.adminCurrentTab === 'categories' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">Categories</button>
             <button onclick="window.setAdminTab('content')" class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm ${state.adminCurrentTab === 'content' ? 'active' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">Site Content</button> <!-- New Tab -->
            </nav></div><div id="admin-content" class="mt-6">${content}</div></div>`; 
            lucide.createIcons(); 
        }
        function calculateDashboardStats() {
            let income = 0, pending = 0, completed = 0, canceled = 0;
            state.orders.forEach(order => {
                if (order.status === 'Completed') income += order.total;
                if (order.status === 'Pending') pending++;
                if (order.status === 'Completed') completed++;
                if (order.status === 'Canceled') canceled++;
            });
            state.dashboardStats = { income, pending, completed, canceled };
        }
        function renderAdminDashboard() {
            calculateDashboardStats(); // Recalculate stats before rendering
            const { income, pending, completed, canceled } = state.dashboardStats;
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-blue-100 p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-blue-800">Total Income</h3>
                        <p class="mt-2 text-3xl font-bold text-blue-900">৳${income.toFixed(2)}</p>
                    </div>
                     <div class="bg-yellow-100 p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-yellow-800">Pending Orders</h3>
                        <p class="mt-2 text-3xl font-bold text-yellow-900">${pending}</p>
                    </div>
                     <div class="bg-green-100 p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-green-800">Completed Orders</h3>
                        <p class="mt-2 text-3xl font-bold text-green-900">${completed}</p>
                    </div>
                     <div class="bg-red-100 p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-red-800">Canceled Orders</h3>
                        <p class="mt-2 text-3xl font-bold text-red-900">${canceled}</p>
                    </div>
                </div>
            `;
        }
        function renderAdminOrders() { if (state.orders.length === 0) return '<p>No orders found.</p>'; const ordersHtml = state.orders.map(order => `<tr class="bg-white hover:bg-gray-50"><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">#${order.id.substring(5,11)}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.customerName}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.date.toLocaleDateString()}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">৳${order.total.toFixed(2)}</td><td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${order.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : order.status === 'Shipped' ? 'bg-blue-100 text-blue-800' : order.status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${order.status}</span></td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">${order.status === 'Pending' ? `<button onclick="window.handleUpdateOrderStatus('${order.id}', 'Shipped')" class="text-indigo-600 hover:text-indigo-900">Ship</button>` : order.status === 'Shipped' ? `<button onclick="window.handleUpdateOrderStatus('${order.id}', 'Completed')" class="text-green-600 hover:text-green-900">Complete</button>` : ''} <button onclick="window.handleUpdateOrderStatus('${order.id}', 'Canceled')" class="text-red-600 hover:text-red-900 ml-2">Cancel</button></td></tr>`).join(''); return `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th><th scope="col" class="relative px-6 py-3"><span class="sr-only">Action</span></th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${ordersHtml}</tbody></table></div>`; }
        function renderAdminProducts() { const productsHtml = state.products.map(p => `<tr class="hover:bg-gray-50"><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.category}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">৳${p.price}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.quantity}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.sold}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4"><button onclick="window.openProductForm('${p.id}')" class="text-indigo-600 hover:text-indigo-900">Edit</button><button onclick="window.handleDeleteProduct('${p.id}')" class="text-red-600 hover:text-red-900">Delete</button></td></tr>`).join(''); return `<div class="flex justify-end mb-4"><button onclick="window.openProductForm()" class="bg-orange-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-orange-600 flex items-center space-x-2"><i data-lucide="plus-circle" class="w-5 h-5"></i><span>Add Product</span></button></div><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sold</th><th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th></tr></thead><tbody class="bg-white divide-y divide-gray-200">${productsHtml}</tbody></table></div>`; } // Added Stock column
        function renderAdminCategories() { const categoriesHtml = state.categories.map(c => `<span class="bg-gray-100 text-gray-800 text-sm font-medium mr-2 mb-2 inline-block px-2.5 py-0.5 rounded">${c}</span>`).join(''); return `<div><h3 class="text-lg font-medium leading-6 text-gray-900">Existing Categories</h3><div class="mt-4 flex flex-wrap">${categoriesHtml}</div></div><div class="mt-8 border-t pt-6"><h3 class="text-lg font-medium leading-6 text-gray-900">Add New Category</h3><form onsubmit="window.handleSaveCategory(event)" class="mt-4 flex items-center space-x-3"><input type="text" id="new-category-name" class="block w-full max-w-xs rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" placeholder="New category name" required><button type="submit" class="bg-orange-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-orange-600">Add</button></form></div>`; }
        
         function renderAdminSiteContent() {
             const pageOptions = Object.keys(state.pageContent).map(key => {
                 // Simple title generation (can be improved)
                 let title = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                 if (key === 'howToBuy') title = 'How to Buy';
                 return `<option value="${key}" ${state.editingPageKey === key ? 'selected' : ''}>${title}</option>`;
             }).join('');

             return `
                <div class="space-y-8">
                    <!-- Homepage Banner Section -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4">Homepage Banner</h3>
                        <div class="flex items-center space-x-4">
                            <img id="banner-preview" src="${state.bannerImageUrl}" class="w-48 h-auto object-cover rounded border" onerror="this.onerror=null;this.src='https://placehold.co/192x77/ccc/000?text=Error';">
                            <div>
                                <label for="banner-upload" class="block text-sm font-medium text-gray-700 mb-1">Upload New Banner</label>
                                <input type="file" id="banner-upload" accept="image/*" onchange="window.handleBannerUpload(event)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                                <p class="text-xs text-gray-500 mt-1">Recommended size: 1200x400 pixels.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Static Page Editor Section -->
                    <div class="border-t pt-8">
                        <h3 class="text-xl font-semibold mb-4">Edit Page Content</h3>
                         <div class="mb-4">
                             <label for="page-select" class="block text-sm font-medium text-gray-700">Select Page to Edit:</label>
                             <select id="page-select" onchange="window.handlePageSelectChange(this.value)" class="mt-1 block w-full max-w-xs rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                 ${pageOptions}
                             </select>
                         </div>
                         <div>
                             <label for="page-content-editor" class="block text-sm font-medium text-gray-700">Page Content (HTML allowed for simple formatting like paragraphs):</label>
                             <textarea id="page-content-editor" rows="15" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500 font-mono text-sm">${state.pageContent[state.editingPageKey] || ''}</textarea>
                         </div>
                         <div class="text-right mt-4">
                              <button onclick="window.handleSavePageContent()" class="bg-orange-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-orange-600">Save Page Content</button>
                         </div>
                    </div>
                </div>
             `;
         }

        // --- USER PROFILE RENDER FUNCTIONS ---
         function maskEmail(email) {
            if (!email) return '';
            const [localPart, domain] = email.split('@');
            if (localPart.length <= 2) return `${localPart}***@${domain}`;
            return `${localPart.substring(0, 2)}****@${domain}`;
         }

        function renderProfilePage() {
            let content = '';
            let pageTitle = "Manage My Account"; // Default Title

            // Determine content based on the active tab
            switch(state.profileCurrentTab) {
                case 'profile': content = renderProfileEditView(); pageTitle="My Profile"; break; // Use specific edit view
                case 'address': content = renderAddressBookView(); pageTitle="Address Book"; break; 
                case 'payment': content = renderPaymentOptionsView(); pageTitle="My Payment Options"; break; 
                case 'wallet': content = renderWalletView(); pageTitle="KongShop Wallet"; break; 
                case 'orders': content = renderProfileOrders(); pageTitle="My Orders"; break;
                case 'returns': content = renderReturnsView(); pageTitle="My Returns"; break; 
                case 'cancellations': content = renderCancellationsView(); pageTitle="My Cancellations"; break; 
                case 'reviews': content = renderReviewsView(); pageTitle="My Reviews"; break; 
                case 'wishlist': content = renderWishlistView(); pageTitle="My Wishlist & Followed Stores"; break; 
                case 'sell': content = renderSellOnKongShopView(); pageTitle="Sell On KongShop"; break; 
                case 'manage': // Default view combining profile and address summary
                default:
                    content = renderManageMyAccountView();
                    state.profileCurrentTab = 'manage'; // Ensure tab state is correct
                    pageTitle = "Manage My Account";
                    break; 
            }

            mainContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <!-- Sidebar -->
                    <div class="md:col-span-1">
                        <div class="bg-white p-4 rounded-lg shadow-lg space-y-4">
                            <p class="text-sm text-gray-500">Hello, ${state.currentUser.displayName}</p>
                            
                            <div>
                                <h3 class="font-semibold text-gray-800 mb-2">Manage My Account</h3>
                                <nav class="flex flex-col space-y-1">
                                     {/* Highlight My Profile if current tab is 'manage' or 'profile' */}
                                    <a href="#" onclick="window.setProfileTab('profile')" class="profile-sidebar-link ${['manage', 'profile'].includes(state.profileCurrentTab) ? 'active' : ''}">My Profile</a>
                                    <a href="#" onclick="window.setProfileTab('address')" class="profile-sidebar-link ${state.profileCurrentTab === 'address' ? 'active' : ''}">Address Book</a>
                                    <a href="#" onclick="window.setProfileTab('payment')" class="profile-sidebar-link ${state.profileCurrentTab === 'payment' ? 'active' : ''}">My Payment Options</a>
                                    <a href="#" onclick="window.setProfileTab('wallet')" class="profile-sidebar-link ${state.profileCurrentTab === 'wallet' ? 'active' : ''}">KongShop Wallet</a>
                                </nav>
                            </div>

                             <div>
                                <h3 class="font-semibold text-gray-800 mb-2">My Orders</h3>
                                <nav class="flex flex-col space-y-1">
                                    <a href="#" onclick="window.setProfileTab('orders')" class="profile-sidebar-link ${state.profileCurrentTab === 'orders' ? 'active' : ''}">My Orders</a>
                                    <a href="#" onclick="window.setProfileTab('returns')" class="profile-sidebar-link ${state.profileCurrentTab === 'returns' ? 'active' : ''}">My Returns</a>
                                    <a href="#" onclick="window.setProfileTab('cancellations')" class="profile-sidebar-link ${state.profileCurrentTab === 'cancellations' ? 'active' : ''}">My Cancellations</a>
                                </nav>
                            </div>
                            
                            <a href="#" onclick="window.setProfileTab('reviews')" class="profile-sidebar-link ${state.profileCurrentTab === 'reviews' ? 'active' : ''}">My Reviews</a>
                            <a href="#" onclick="window.setProfileTab('wishlist')" class="profile-sidebar-link ${state.profileCurrentTab === 'wishlist' ? 'active' : ''}">My Wishlist & Followed Stores</a>
                            <a href="#" onclick="window.setProfileTab('sell')" class="profile-sidebar-link ${state.profileCurrentTab === 'sell' ? 'active' : ''}">Sell On KongShop</a>

                        </div>
                    </div>
                    <!-- Main Content -->
                    <div class="md:col-span-3 bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-6">${pageTitle}</h2>
                        ${content}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderManageMyAccountView() {
            const user = state.currentUser;
             return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Personal Profile Section -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                             <h3 class="text-lg font-semibold text-gray-700">Personal Profile</h3>
                             <button onclick="window.openEditProfileModal()" class="text-sm text-blue-600 hover:underline">EDIT</button>
                        </div>
                        <div class="space-y-2 text-gray-600">
                             <p>${user.displayName}</p>
                             <p>${maskEmail(user.email)}</p>
                             <div class="flex items-center pt-2">
                                <input id="receiveMarketing" type="checkbox" ${user.profile?.marketingEmails ? 'checked' : ''} onclick="handleMarketingEmailToggle(this.checked)" class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                                <label for="receiveMarketing" class="ml-2 block text-sm text-gray-900">Receive marketing emails</label>
                            </div>
                        </div>
                    </div>
                    <!-- Address Book Section -->
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-700">Address Book</h3>
                            <button onclick="window.openAddressModal('shipping', false)" class="text-sm text-blue-600 hover:underline flex items-center"><i data-lucide="plus" class="w-4 h-4 mr-1"></i>Add</button>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div class="border p-4 rounded-md">
                                <h4 class="font-medium text-gray-800 mb-1">Default Shipping Address</h4>
                                ${user.profile?.address ? 
                                    `<p class="text-sm text-gray-600">${user.profile.address.replace(/\n/g, '<br>')}</p> 
                                    <button onclick="window.openAddressModal('shipping', true)" class="text-xs text-blue-500 hover:underline mt-1">Edit Address</button>` : 
                                    `<p class="text-sm text-gray-500">You have not set a default shipping address.</p>`
                                }
                            </div>
                             <div class="border p-4 rounded-md">
                                <h4 class="font-medium text-gray-800 mb-1">Default Billing Address</h4>
                                ${user.profile?.billingAddress ? 
                                    `<p class="text-sm text-gray-600">${user.profile.billingAddress.replace(/\n/g, '<br>')}</p>
                                    <button onclick="window.openAddressModal('billing', true)" class="text-xs text-blue-500 hover:underline mt-1">Edit Address</button>` : 
                                    `<p class="text-sm text-gray-500">You have not set a default billing address.</p>`
                                }
                             </div>
                        </div>
                    </div>
                </div>
             `;
        }

        // --- New render functions for profile sections ---
        function renderAddressBookView() { 
            const user = state.currentUser;
            const hasShipping = user.profile?.address;
            const hasBilling = user.profile?.billingAddress;

             return `
                <div class="flex justify-end mb-4">
                    <button onclick="window.openAddressModal(null, false)" class="bg-orange-500 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-orange-600 flex items-center space-x-1">
                        <i data-lucide="plus" class="w-4 h-4"></i><span>Add New Address</span>
                    </button>
                </div>
                 <div class="space-y-4">
                     <div class="border p-4 rounded-md bg-gray-50">
                         <div class="flex justify-between items-center mb-2">
                             <h4 class="font-semibold text-gray-800">Shipping Address ${hasShipping ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full ml-2">Default</span>' : ''}</h4>
                              <button onclick="window.openAddressModal('shipping', ${hasShipping})" class="text-sm text-blue-600 hover:underline">${hasShipping ? 'Edit' : 'Add'}</button>
                         </div>
                         ${hasShipping ? `<p class="text-sm text-gray-600">${user.profile.address.replace(/\n/g, '<br>')}</p>` : '<p class="text-sm text-gray-500">No default shipping address set.</p>'}
                     </div>
                      <div class="border p-4 rounded-md bg-gray-50">
                          <div class="flex justify-between items-center mb-2">
                             <h4 class="font-semibold text-gray-800">Billing Address ${hasBilling ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full ml-2">Default</span>' : ''}</h4>
                              <button onclick="window.openAddressModal('billing', ${hasBilling})" class="text-sm text-blue-600 hover:underline">${hasBilling ? 'Edit' : 'Add'}</button>
                         </div>
                         ${hasBilling ? `<p class="text-sm text-gray-600">${user.profile.billingAddress.replace(/\n/g, '<br>')}</p>` : '<p class="text-sm text-gray-500">No default billing address set.</p>'}
                     </div>
                     {/* Add loop here for additional addresses if needed */}
                 </div>
            `; 
        }

        function renderPaymentOptionsView() { 
            // Mock data - replace with actual data if storing payment info (NOT RECOMMENDED without proper security)
            const mockPayments = [
                 { type: 'Visa', details: '**** **** **** 1234', default: true },
                 { type: 'bKash', details: '017***1234', default: false },
            ];
             const paymentHtml = mockPayments.map(p => `
                 <div class="border p-4 rounded-md flex justify-between items-center">
                     <div>
                         <p class="font-medium">${p.type} ${p.default ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full ml-2">Default</span>' : ''}</p>
                         <p class="text-sm text-gray-500">${p.details}</p>
                     </div>
                     <div>
                         ${!p.default ? '<button class="text-xs text-blue-500 hover:underline mr-2">Set as Default</button>' : ''}
                         <button class="text-xs text-red-500 hover:underline">Remove</button>
                     </div>
                 </div>
             `).join('');

            return `
                 <div class="flex justify-end mb-4">
                     <button onclick="showToast('Add Payment Simulation', 'info')" class="bg-orange-500 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-orange-600 flex items-center space-x-1">
                        <i data-lucide="plus" class="w-4 h-4"></i><span>Add Payment Method</span>
                    </button>
                 </div>
                 <div class="space-y-4">
                     ${paymentHtml}
                 </div>
             `; 
        }

        function renderWalletView() { 
             const mockBalance = 500.00;
             const mockTransactions = [
                 { date: new Date('2025-10-20'), description: 'Refund Order #103', amount: 150.00, type: 'credit' },
                 { date: new Date('2025-10-15'), description: 'Top-up via bKash', amount: 500.00, type: 'credit' },
                 { date: new Date('2025-10-12'), description: 'Payment Order #101', amount: -3349.00, type: 'debit' },
             ];
             const transactionHtml = mockTransactions.map(t => `
                 <tr class="hover:bg-gray-50">
                     <td class="px-4 py-3 text-sm">${t.date.toLocaleDateString()}</td>
                     <td class="px-4 py-3 text-sm">${t.description}</td>
                     <td class="px-4 py-3 text-sm text-right ${t.type === 'credit' ? 'text-green-600' : 'text-red-600'}">
                         ${t.type === 'credit' ? '+' : '-'} ৳${Math.abs(t.amount).toFixed(2)}
                     </td>
                 </tr>
             `).join('');

             return `
                 <div class="mb-6">
                     <p class="text-lg text-gray-600">Current Balance:</p>
                     <p class="text-4xl font-bold text-orange-600">৳${mockBalance.toFixed(2)}</p>
                 </div>
                 <div class="border-t pt-6">
                     <h4 class="font-semibold text-lg mb-3">Transaction History</h4>
                     <div class="overflow-x-auto">
                        <table class="min-w-full divide-y">
                            <thead><tr><th class="px-4 py-2 text-left">Date</th><th class="px-4 py-2 text-left">Description</th><th class="px-4 py-2 text-right">Amount</th></tr></thead>
                            <tbody>${transactionHtml}</tbody>
                        </table>
                    </div>
                 </div>
             `; 
        }

        function renderReturnsView() { 
            const mockReturns = [
                 { orderId: 'order101', item: 'Men\'s Casual Shirt', status: 'Processing', date: new Date('2025-10-22') },
                 { orderId: 'order098', item: 'Wireless Earbuds', status: 'Refunded', date: new Date('2025-10-18') },
            ];
             const returnsHtml = mockReturns.map(r => `
                 <tr class="hover:bg-gray-50">
                     <td class="px-4 py-3 text-sm">#${r.orderId.substring(5,11)}</td>
                     <td class="px-4 py-3 text-sm">${r.item}</td>
                     <td class="px-4 py-3 text-sm">${r.date.toLocaleDateString()}</td>
                     <td class="px-4 py-3 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${r.status === 'Processing' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${r.status}</span></td>
                 </tr>
             `).join('');

             return `
                  <div class="flex justify-end mb-4">
                     <button onclick="showToast('Return Request Simulation', 'info')" class="bg-orange-500 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-orange-600 flex items-center space-x-1">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i><span>Request Return</span>
                    </button>
                 </div>
                 <div class="overflow-x-auto">
                     <table class="min-w-full divide-y">
                         <thead><tr><th class="px-4 py-2 text-left">Order ID</th><th class="px-4 py-2 text-left">Item</th><th class="px-4 py-2 text-left">Request Date</th><th class="px-4 py-2 text-left">Status</th></tr></thead>
                         <tbody>${returnsHtml}</tbody>
                     </table>
                 </div>
             `; 
        }
        function renderCancellationsView() { 
            const cancelledOrders = state.orders.filter(o => o.userId === state.currentUser.uid && o.status === 'Canceled');
            if (cancelledOrders.length === 0) return `<p>You have no cancelled orders.</p>`;

             const ordersHtml = cancelledOrders.map(order => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium">#${order.id.substring(5,11)}</td>
                    <td class="px-4 py-3 text-sm">${order.date.toLocaleDateString()}</td>
                    <td class="px-4 py-3 text-sm">৳${order.total.toFixed(2)}</td>
                     <td class="px-4 py-3 text-sm text-right"><button onclick="window.showOrderDetails('${order.id}')" class="text-indigo-600 hover:text-indigo-900">View Details</button></td>
                </tr>`).join('');
            return `<div class="overflow-x-auto"><table class="min-w-full divide-y"><thead><tr><th class="px-4 py-2 text-left">Order ID</th><th class="px-4 py-2 text-left">Date Canceled</th><th class="px-4 py-2 text-left">Total</th><th></th></tr></thead><tbody>${ordersHtml}</tbody></table></div>`;
        }

         function renderReviewsView() { 
             const userReviews = [];
             state.products.forEach(product => {
                 if (product.reviews && product.reviews.length > 0) {
                     product.reviews.forEach(review => {
                         if (review.userId === state.currentUser.uid) {
                             userReviews.push({ ...review, productName: product.name, productId: product.id });
                         }
                     });
                 }
             });

             if (userReviews.length === 0) return `<p>You have not submitted any reviews yet.</p>`;

             const reviewsHtml = userReviews.map(review => `
                 <div class="border-t py-4">
                     <div class="flex justify-between items-start">
                        <div>
                             <p class="font-semibold text-gray-800 mb-1">
                                <a href="#" onclick="window.handleNavigation('product', '${review.productId}')" class="hover:underline hover:text-orange-600">${review.productName}</a>
                             </p>
                             <div class="flex text-yellow-400 mb-1">${'<i data-lucide="star" class="w-4 h-4 fill-current"></i>'.repeat(review.rating)}</div>
                            <p class="text-gray-600 text-sm">${review.text}</p>
                            <p class="text-xs text-gray-400 mt-1">${review.date.toLocaleDateString()}</p>
                        </div>
                         <button onclick="showToast('Edit Review - Coming Soon!', 'info')" class="text-xs text-blue-500 hover:underline">Edit</button> {/* Placeholder Edit */}
                     </div>
                 </div>
             `).join('');

             return `<div class="space-y-4">${reviewsHtml}</div>`; 
         }
        function renderWishlistView() { return `<p>Your wishlist and followed stores will appear here. (Coming Soon)</p>`; }
        function renderSellOnKongShopView() { return `<p>Interested in selling on KongShop? Contact us for more details. (Coming Soon)</p>`; }


        // --- Updated/Kept functions ---
        function renderProfileEditView() { // Renamed from renderProfileInfo
            const user = state.currentUser;
            // This function is now used when 'My Profile' is clicked in sidebar
             return `
                 <form id="profile-form" onsubmit="window.handleUpdateProfileFull(event)">
                     <div class="space-y-4">
                        <div><label class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="profile-name-full" value="${user.displayName}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500" required></div>
                        <div><label class="block text-sm font-medium text-gray-700">Email</label><input type="email" value="${user.email}" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm" disabled></div>
                        <div><label class="block text-sm font-medium text-gray-700">Phone Number</label><input type="tel" id="profile-phone-full" value="${user.profile?.phone || ''}" placeholder="e.g., 01712345678" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500"></div>
                          <div class="flex items-center pt-2">
                             <input id="profile-marketing-full" type="checkbox" ${user.profile?.marketingEmails ? 'checked' : ''} class="h-4 w-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                             <label for="profile-marketing-full" class="ml-2 block text-sm text-gray-900">Receive marketing emails</label>
                         </div>
                     </div>
                     <div class="mt-6 border-t pt-6">
                         ${renderProfileSettings()} {/* Embed password change here */}
                     </div>
                     <div class="text-right mt-6">
                          <button type="submit" class="bg-orange-500 text-white py-2 px-6 rounded-lg font-semibold hover:bg-orange-600">Save Changes</button>
                     </div>
                 </form>
             `;
        }
        function renderProfileOrders() {
            const userOrders = state.orders.filter(o => o.userId === state.currentUser.uid);
            if(userOrders.length === 0) return `<p>You have not placed any orders yet.</p>`; // Removed title H2

            const ordersHtml = userOrders.map(order => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm font-medium">#${order.id.substring(5,11)}</td>
                    <td class="px-4 py-3 text-sm">${order.date.toLocaleDateString()}</td>
                    <td class="px-4 py-3 text-sm">৳${order.total.toFixed(2)}</td>
                    <td class="px-4 py-3 text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${order.status === 'Pending' ? 'bg-yellow-100 text-yellow-800' : order.status === 'Shipped' ? 'bg-blue-100 text-blue-800' : order.status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${order.status}</span></td>
                    <td class="px-4 py-3 text-sm text-right"><button onclick="window.showOrderDetails('${order.id}')" class="text-indigo-600 hover:text-indigo-900">View</button></td>
                </tr>`).join('');
            return `<div class="overflow-x-auto"><table class="min-w-full divide-y"><thead><tr><th class="px-4 py-2 text-left">Order ID</th><th class="px-4 py-2 text-left">Date</th><th class="px-4 py-2 text-left">Total</th><th class="px-4 py-2 text-left">Status</th><th></th></tr></thead><tbody>${ordersHtml}</tbody></table></div>`;
        }
        
        // --- GLOBAL EVENT HANDLERS & LOGIC ---
        function updateCartCount() { const cartCountEl = document.getElementById('cart-count'); if (cartCountEl) { cartCountEl.textContent = state.cart.reduce((sum, item) => sum + item.quantity, 0); } }
        function showToast(message, type = 'success') { toastElement.textContent = message; toastElement.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-transform duration-300 z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`; toastElement.classList.remove('translate-x-[120%]'); setTimeout(() => { toastElement.classList.add('translate-x-[120%]'); }, 3000); }
        function handleAddToCart(productId) { 
            const product = state.products.find(p => p.id === productId); 
            if (product.quantity <= 0) {
                 showToast('Sorry, this item is out of stock.', 'error');
                 return;
            }
            const existingItem = state.cart.find(item => item.id === productId); 
            if (existingItem) { 
                if (existingItem.quantity < product.quantity) {
                     existingItem.quantity++; 
                     updateCartCount(); 
                     showToast('Item quantity updated in cart!'); 
                } else {
                     showToast('Cannot add more, item limit reached.', 'error');
                }
            } else { 
                state.cart.push({ ...product, quantity: 1 }); 
                 updateCartCount(); 
                 showToast('Item added to cart!'); 
            } 
        }
        function handleBuyNow(productId) { 
             const product = state.products.find(p => p.id === productId); 
            if (!state.isLoggedIn) { 
                showToast('Please log in to buy.', 'error'); 
                showModal('login-modal'); 
                return; 
            } 
             if (product.quantity <= 0) {
                 showToast('Sorry, this item is out of stock.', 'error');
                 return;
             }
            state.cart = [{ ...product, quantity: 1 }]; 
            updateCartCount(); 
            handleNavigation('checkout'); 
        }
        function handleRemoveFromCart(productId) { state.cart = state.cart.filter(item => item.id !== productId); updateCartCount(); renderCartPage(); }
        function handleQuantityChange(productId, newQuantity) { 
            const product = state.products.find(p => p.id === productId); // Find the original product for stock check
            const cartItem = state.cart.find(item => item.id === productId); 
            
            if (newQuantity < 1) { 
                handleRemoveFromCart(productId); 
                return; 
            } 
            if (newQuantity > product.quantity) {
                 showToast(`Only ${product.quantity} items available in stock.`, 'error');
                 // Optionally reset cart quantity to max available, or leave as is
                 // cartItem.quantity = product.quantity; 
                 // updateCartCount(); 
                 // renderCartPage();
                 return; 
            }
            if(cartItem) { 
                cartItem.quantity = newQuantity; 
                updateCartCount(); 
                renderCartPage(); 
            } 
        }
        function handleSearch(force = false) { const query = searchInput.value.toLowerCase(); if (force || query) { handleNavigation('search', query); } else if (!query) { handleNavigation('home'); } }
        
        async function notifyDiscord(newOrder) {
            const webhookUrl = 'https://discord.com/api/webhooks/1430155666638639146/RfCydlHbNTfJBmvo0CkHkfZMmVOzNAsjhWeX-wRXd5SSF1oAB8Pocm4HluKUwL2Goyjy';
            const itemsDescription = newOrder.items.map(item => `${item.name} (x${item.quantity}) - ৳${(item.price * item.quantity).toFixed(2)}`).join('\n');
            const discordPayload = {
                content: `New order from ${newOrder.customerName}!`,
                embeds: [{
                    title: '🎉 New Order Received!',
                    color: 16747520, // Orange
                    fields: [
                        { name: 'Order ID', value: `#${newOrder.id.substring(5,11)}`, inline: true },
                        { name: 'Customer', value: newOrder.customerName, inline: true },
                        { name: 'Total Amount', value: `৳${newOrder.total.toFixed(2)}`, inline: true },
                        { name: 'Items Ordered', value: "```" + itemsDescription + "```" }
                    ],
                    timestamp: new Date().toISOString(),
                    footer: { text: 'KongShop E-commerce' }
                }]
            };

            try {
                await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(discordPayload),
                });
            } catch (error) {
                console.error('Error sending Discord notification:', error);
            }
        }

        function handlePlaceOrder(event) { // Removed async
            event.preventDefault();
            if (!state.isLoggedIn) {
                showToast('Please log in to place an order.', 'error');
                showModal('login-modal');
                return;
            }

            // Check stock before placing order
            let insufficientStock = false;
            state.cart.forEach(cartItem => {
                const productInStock = state.products.find(p => p.id === cartItem.id);
                if (!productInStock || cartItem.quantity > productInStock.quantity) {
                    showToast(`Insufficient stock for ${cartItem.name}. Only ${productInStock ? productInStock.quantity : 0} available.`, 'error');
                    insufficientStock = true;
                }
            });

            if (insufficientStock) {
                renderCartPage(); // Re-render cart to show potential issues or just prevent order
                return; 
            }

            // If stock is sufficient, proceed
            const newOrderId = `order${Date.now()}`; // Simple unique ID
            const orderData = {
                id: newOrderId,
                userId: state.currentUser.uid,
                customerName: state.currentUser.displayName,
                total: state.cart.reduce((total, item) => total + (item.price * item.quantity), 0) + 50,
                status: 'Pending',
                date: new Date(),
                items: state.cart.map(i => ({ ...i })) // Create copies of cart items
            };
            
            // Decrease stock quantity
            orderData.items.forEach(orderedItem => {
                 const productIndex = state.products.findIndex(p => p.id === orderedItem.id);
                 if (productIndex !== -1) {
                     state.products[productIndex].quantity -= orderedItem.quantity;
                     // In a real DB, you'd update the product quantity here
                 }
            });
            
            state.orders.push(orderData); // Add to local state
            notifyDiscord(orderData); // Still notify Discord (async but we don't wait)

            state.cart = [];
            updateCartCount();
            handleNavigation('orderConfirmation');
        }

        function updateActiveNavLink(page) { navbar.querySelectorAll('.nav-link').forEach(link => { link.classList.toggle('active', link.dataset.page === page); }); }
        
        function handleNavigation(page, data = null) {
            if (page === 'admin' && !state.isAdmin) { showToast('Access Denied.', 'error'); page = 'home'; }
            if (page === 'profile' && !state.isLoggedIn) { showToast('Please log in to view your profile.', 'error'); showModal('login-modal'); return; }
            state.currentPage = page;
            mainContent.innerHTML = renderLoader();
            window.scrollTo(0, 0);
            updateActiveNavLink(page);
            if(page !== 'search' && page !== 'category') { searchInput.value = ''; }
             if (page === 'profile' && !['profile', 'address', 'payment', 'wallet', 'orders', 'returns', 'cancellations', 'reviews', 'wishlist', 'sell'].includes(state.profileCurrentTab)) { 
                 state.profileCurrentTab = 'manage'; // Reset to default if navigating directly to profile page
             }

            setTimeout(() => {
                switch (page) {
                    case 'home': renderHomePage(); break;
                    case 'shop': renderShopPage(); break;
                    case 'howToBuy': renderHowToBuyPage(); break;
                    case 'about': renderAboutUsPage(); break;
                    case 'contact': renderContactPage(); break;
                    case 'admin': renderAdminPanel(); break;
                    case 'profile': renderProfilePage(); break; // This will now render based on state.profileCurrentTab
                    case 'product': state.currentProduct = data; renderProductDetailsPage(); break; // Uses state.products now
                    case 'cart': renderCartPage(); break;
                    case 'checkout': renderCheckoutPage(); break;
                    case 'orderConfirmation': renderOrderConfirmationPage(); break;
                    case 'category': state.currentCategory = data; renderFilteredProductsPage(`Category: ${data}`, state.products.filter(p => p.category === data)); break;
                    case 'search': state.searchQuery = data; renderFilteredProductsPage(`Search Results for "${data}"`, state.products.filter(p => p.name.toLowerCase().includes(data) || p.category.toLowerCase().includes(data))); break;
                    case 'privacy': renderPolicyPage('privacy', 'Privacy Policy'); break;
                    case 'returns': renderPolicyPage('returns', 'Return & Refund Policy'); break;
                    default: renderHomePage();
                }
            }, 300);
        }

        // --- AUTH & MODAL LOGIC (now on window object) ---
        window.showModal = (modalId) => { const modal = document.getElementById(modalId); if (modal) modal.classList.remove('hidden'); }
        window.hideModal = (modalId) => { const modal = document.getElementById(modalId); if (modal) modal.classList.add('hidden'); }
        window.togglePasswordVisibility = (inputId) => { const input = document.getElementById(inputId); const icon = input.nextElementSibling.querySelector('i'); if (input.type === 'password') { input.type = 'text'; icon.setAttribute('data-lucide', 'eye-off'); } else { input.type = 'password'; icon.setAttribute('data-lucide', 'eye'); } lucide.createIcons(); }
        
        // Removed handleGoogleSignIn
        
        function handleLogin(event) { // Simplified login without Firebase/OTP
            event.preventDefault(); 
            const email = document.getElementById('login-email').value.toLowerCase();
            const password = document.getElementById('login-password').value; // In real app, verify password
            
            // Basic simulation: Check if user exists (or create mock user if not)
             const adminEmails = ['admin@kongshop.com', 'ifronrobiul@gmail.com'];
             const isAdmin = adminEmails.includes(email);
             
             // Check mock password (replace with real validation later if needed)
             const MOCK_PASS = "password123"; // Example password for all users
             if (password !== MOCK_PASS && !isAdmin) { // Admins can use any password for now
                showToast('Invalid credentials.', 'error');
                return;
             }
             
             state.isLoggedIn = true;
             state.currentUser = { 
                 uid: `mock_${email}`, 
                 displayName: email.split('@')[0], 
                 email: email, 
                 isAdmin: isAdmin,
                 profile: { phone: '', address: '', marketingEmails: false, billingAddress: '' } // Add new profile fields
             };
             state.isAdmin = isAdmin;

             showToast(`Welcome, ${state.currentUser.displayName}!`);
             updateHeaderUI();
             hideModal('login-modal');
             handleNavigation('home'); // Go home after login
        }
        window.handleLogin = handleLogin;
        
        // Removed handleOtpSubmit

        function handleSignup(event) { // Simplified signup
            event.preventDefault(); 
            const name = document.getElementById('signup-name').value; 
            const email = document.getElementById('signup-email').value.toLowerCase(); 
            const password = document.getElementById('signup-password').value;
             
            // Basic simulation: Directly log in the new user
             state.isLoggedIn = true;
             state.currentUser = { 
                 uid: `mock_${email}`, 
                 displayName: name, 
                 email: email, 
                 isAdmin: false, // New signups are not admins
                 profile: { phone: '', address: '', marketingEmails: false, billingAddress: '' } // Add new profile fields
             };
             state.isAdmin = false;
             
             showToast(`Welcome, ${state.currentUser.displayName}! Your account is created.`);
             updateHeaderUI();
             hideModal('signup-modal');
             handleNavigation('home'); // Go home after signup
        }
        window.handleSignup = handleSignup;
        
        function handleLogout() { // Simplified logout
             state.isLoggedIn = false;
             state.currentUser = null;
             state.isAdmin = false;
             showToast('You have been logged out.');
             updateHeaderUI();
             handleNavigation('home');
        }
        window.handleLogout = handleLogout;
        
        // --- ADMIN ACTION HANDLERS (now on window object) ---
        window.setAdminTab = (tab) => { state.adminCurrentTab = tab; renderAdminPanel(); }
        
        function handleUpdateOrderStatus(orderId, newStatus) { // Updated for state array
            const order = state.orders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                showToast(`Order #${orderId.substring(5,11)} updated to ${newStatus}.`);
                renderAdminPanel(); // Re-render admin panel to show change
            }
        }
        window.handleUpdateOrderStatus = handleUpdateOrderStatus;

        function handleDeleteProduct(productId) { // Updated for state array
            if (confirm('Are you sure you want to delete this product?')) { 
                state.products = state.products.filter(p => p.id !== productId);
                showToast('Product deleted successfully.', 'success'); 
                renderAdminPanel(); // Re-render relevant parts
            } 
        }
        window.handleDeleteProduct = handleDeleteProduct;

        
        window.handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('product-image-preview').src = e.target.result;
                    document.getElementById('product-image').value = e.target.result; // Store as Base64 Data URL
                }
                reader.readAsDataURL(file);
            }
        }

        window.openProductForm = (productId = null) => {
            const form = document.getElementById('product-form');
            form.reset();
            document.getElementById('product-image-upload').onchange = window.handleImageUpload;
            const modalTitle = document.getElementById('product-modal-title');
            const categorySelect = document.getElementById('product-category');
            const imagePreview = document.getElementById('product-image-preview');
            const hiddenImageInput = document.getElementById('product-image');
            const discountPercentInput = document.getElementById('product-discount-percent');
             const discountTextInput = document.getElementById('product-discount-text'); // Get discount text input
             const quantityInput = document.getElementById('product-quantity'); // Get quantity input


            categorySelect.innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            if (productId) {
                const product = state.products.find(p => p.id === productId);
                 if (product) {
                    modalTitle.textContent = 'Edit Product';
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-category').value = product.category;
                    document.getElementById('product-price').value = product.price;
                     // Calculate percentage if oldPrice exists and discountText is empty
                     if (product.oldPrice && product.oldPrice > product.price && !product.discountText) {
                         discountPercentInput.value = (((product.oldPrice - product.price) / product.oldPrice) * 100).toFixed(1);
                     } else {
                         discountPercentInput.value = ''; // Clear if custom text or no discount
                     }
                    hiddenImageInput.value = product.image; 
                    imagePreview.src = product.image;
                    discountTextInput.value = product.discountText || ''; // Populate discount text
                     quantityInput.value = product.quantity || 0; // Populate quantity
                } else {
                     showToast('Product not found for editing.', 'error');
                     return; 
                }
            } else {
                modalTitle.textContent = 'Add New Product';
                document.getElementById('product-id').value = '';
                 discountPercentInput.value = ''; // Clear discount percent
                hiddenImageInput.value = '';
                imagePreview.src = 'https://placehold.co/100x100/F5F5F5/CCC?text=Preview';
                 discountTextInput.value = ''; // Clear discount text for new product
                 quantityInput.value = 0; // Default quantity for new product
            }
            showModal('product-modal');
            lucide.createIcons();
        }
        
        function handleSaveProduct(event) { // Updated for state array
            event.preventDefault();
            const id = document.getElementById('product-id').value;
            const imageUrl = document.getElementById('product-image').value; // This is now a Data URL or placeholder

            if (!imageUrl || imageUrl === 'https://placehold.co/100x100/F5F5F5/CCC?text=Preview') { 
                showToast('Please upload an image for the product.', 'error'); 
                return; 
            }

             const price = parseFloat(document.getElementById('product-price').value);
             const discountPercent = parseFloat(document.getElementById('product-discount-percent').value);
             let oldPrice = 0;
             if (!isNaN(discountPercent) && discountPercent > 0 && discountPercent <= 100) {
                 // Calculate oldPrice based on discount percentage
                 oldPrice = price / (1 - (discountPercent / 100));
             } else {
                 // If no valid percentage, maybe keep existing oldPrice if editing, or set to 0/price
                  oldPrice = price; // Or keep existing if id exists: state.products.find(p=>p.id === id)?.oldPrice || price;
             }


            const productData = { 
                name: document.getElementById('product-name').value, 
                category: document.getElementById('product-category').value, 
                price: price, 
                oldPrice: oldPrice, // Use calculated or original price
                quantity: parseInt(document.getElementById('product-quantity').value) || 0, // Get quantity
                image: imageUrl, 
                rating: 4.5, // Default rating
                sold: 0, // Default sold count for new, keep existing for edit
                reviews: [], questions: [],
                discountText: document.getElementById('product-discount-text').value.trim() // Get discount text
            }; 

            if (id) {
                const index = state.products.findIndex(p => p.id === id); 
                 if (index !== -1) {
                    productData.reviews = state.products[index].reviews; // Keep existing reviews/questions
                    productData.questions = state.products[index].questions;
                    productData.sold = state.products[index].sold; // Keep existing sold count
                    productData.rating = state.products[index].rating; // Keep existing rating
                     if (isNaN(discountPercent) || discountPercent <= 0) { // If discount removed, reset oldPrice
                         productData.oldPrice = productData.price;
                     }
                    state.products[index] = { ...state.products[index], ...productData }; 
                    showToast('Product updated successfully!'); 
                } else {
                     showToast('Error updating product.', 'error');
                }
            } else { 
                 productData.id = `prod${Date.now()}`; // Create a simple unique ID
                 state.products.push(productData); 
                 showToast('Product added successfully!'); 
            } 
            hideModal('product-modal'); 
            renderAdminPanel(); // Re-render admin product list
             if (state.currentPage === 'shop' || state.currentPage === 'home') { // Refresh shop/home if visible
                 handleNavigation(state.currentPage);
             }
        }
        window.handleSaveProduct = handleSaveProduct;

        function handleSaveCategory(event) { event.preventDefault(); const newCategory = document.getElementById('new-category-name').value; if (newCategory && !state.categories.includes(newCategory)) { state.categories.push(newCategory); renderAdminPanel(); showToast(`Category "${newCategory}" added.`); document.getElementById('new-category-name').value = ''; } else { showToast('Category is empty or already exists.', 'error'); } }
        window.handleSaveCategory = handleSaveCategory;

         // --- ADMIN SITE CONTENT HANDLERS ---
         window.handleBannerUpload = (event) => {
             const file = event.target.files[0];
             if (file) {
                 const reader = new FileReader();
                 reader.onload = function(e) {
                     state.bannerImageUrl = e.target.result;
                     document.getElementById('banner-preview').src = e.target.result; // Update preview
                     showToast('Banner image updated. Changes will show on next homepage load.');
                     // Optionally re-render admin panel if needed, but not necessary just for preview
                 }
                 reader.readAsDataURL(file);
             }
         }

         window.handlePageSelectChange = (selectedPageKey) => {
             state.editingPageKey = selectedPageKey;
             // Update the textarea content when dropdown changes
             document.getElementById('page-content-editor').value = state.pageContent[selectedPageKey] || '';
         }

         window.handleSavePageContent = () => {
             const currentPageKey = state.editingPageKey;
             const newContent = document.getElementById('page-content-editor').value;
             state.pageContent[currentPageKey] = newContent;
             showToast('Page content saved successfully.');
             // No need to re-render the admin panel, just update state
         }

        // --- PRODUCT PAGE INTERACTION HANDLERS ---
        function handlePostReview(event, productId) { // Updated for state array
            event.preventDefault();
            const rating = event.target.rating.value;
            const text = event.target['review-text'].value;
            if (!rating) { showToast('Please select a rating.', 'error'); return; }

            const newReview = {
                user: state.currentUser.displayName,
                userId: state.currentUser.uid,
                rating: parseInt(rating),
                text: text,
                date: new Date()
            };

            const product = state.products.find(p => p.id === productId);
            if (product) {
                 product.reviews = [newReview, ...(product.reviews || [])];
                 renderProductDetailsPage(); // Re-render to show new review
                 showToast('Thank you for your review!');
            } else {
                 showToast('Error finding product to add review.', 'error');
            }
        }
        window.handlePostReview = handlePostReview;

        function handlePostQuestion(event, productId) { // Updated for state array
            event.preventDefault();
            const questionText = event.target['question-text'].value;
            const newQuestion = {
                user: state.currentUser.displayName,
                userId: state.currentUser.uid,
                question: questionText,
                answer: null, 
                date: new Date()
            };
            const product = state.products.find(p => p.id === productId);
             if (product) {
                 product.questions = [...(product.questions || []), newQuestion];
                 renderProductDetailsPage(); // Re-render to show new question
                 showToast('Your question has been submitted.');
             } else {
                 showToast('Error finding product to add question.', 'error');
             }
        }
        window.handlePostQuestion = handlePostQuestion;

        // --- USER PROFILE HANDLERS ---
        window.setProfileTab = (tab) => { 
             state.profileCurrentTab = tab; 
             renderProfilePage(); 
        }

        window.openEditProfileModal = () => {
             document.getElementById('profile-name-edit').value = state.currentUser.displayName;
             document.getElementById('profile-email-edit').value = state.currentUser.email;
             document.getElementById('profile-marketing-edit').checked = state.currentUser.profile?.marketingEmails || false;
             showModal('edit-profile-modal');
        }

         function handleUpdateProfile(event) { // Updated for state object & modal (Only updates name & marketing from modal)
            event.preventDefault(); 
            state.currentUser.displayName = document.getElementById('profile-name-edit').value;
             state.currentUser.profile.marketingEmails = document.getElementById('profile-marketing-edit').checked;
            showToast('Profile updated successfully!'); 
            hideModal('edit-profile-modal');
            updateHeaderUI(); // Update header if name changed
            renderProfilePage(); // Re-render profile page
        }
        window.handleUpdateProfile = handleUpdateProfile;
        
         // New handler for the full profile edit view
        function handleUpdateProfileFull(event) { 
             event.preventDefault(); 
             state.currentUser.displayName = document.getElementById('profile-name-full').value;
             state.currentUser.profile.phone = document.getElementById('profile-phone-full').value;
             // Address is handled separately now
             state.currentUser.profile.marketingEmails = document.getElementById('profile-marketing-full').checked;
             showToast('Profile details updated successfully!'); 
             updateHeaderUI(); // Update header if name changed
             renderProfilePage(); // Re-render profile page
         }
         window.handleUpdateProfileFull = handleUpdateProfileFull; // Assign to window


        // Handle marketing email toggle directly from Manage Account view
        window.handleMarketingEmailToggle = (isChecked) => {
             if (state.currentUser && state.currentUser.profile) {
                 state.currentUser.profile.marketingEmails = isChecked;
                 showToast('Marketing email preference updated.');
                 // No need to re-render the whole page, just update the state
             }
        };

        // Address Modal Logic
        window.openAddressModal = (type, isEditing) => {
             const modalTitle = document.getElementById('address-modal-title');
             const form = document.getElementById('address-form');
             form.reset(); // Clear previous data

             const addressTypeInput = document.getElementById('address-type');
             addressTypeInput.value = type || 'shipping'; // Default to shipping if adding new

             modalTitle.textContent = `${isEditing ? 'Edit' : 'Add'} ${type === 'billing' ? 'Billing' : 'Shipping'} Address`;

             const user = state.currentUser;
             const addressKey = type === 'billing' ? 'billingAddress' : 'address';
             const defaultKey = type === 'billing' ? 'defaultBilling' : 'defaultShipping';

             if (isEditing && user.profile && user.profile[addressKey]) {
                 // Pre-fill form for editing (simple example, needs improvement for structured address)
                  const fullAddress = user.profile[addressKey];
                  // Attempt to split address - This is a basic split, might need refinement
                  const parts = fullAddress.split(','); 
                  document.getElementById('address-street').value = parts[0]?.trim() || '';
                  document.getElementById('address-area').value = parts[1]?.trim() || ''; // Assuming Area is second
                  document.getElementById('address-city').value = parts[2]?.trim() || ''; // Assuming City is third
                  document.getElementById('address-region').value = parts[3]?.trim() || ''; // Assuming Region is fourth

                 document.getElementById('address-name').value = user.displayName; // Use profile name as default
                 document.getElementById('address-phone').value = user.profile.phone || ''; // Use profile phone
                 document.getElementById('address-default-shipping').checked = user.profile.defaultShipping || false;
                 document.getElementById('address-default-billing').checked = user.profile.defaultBilling || false;

                 // Select radio based on address label (if stored)
                 const label = user.profile[`${type}AddressLabel`] || '';
                 const labelRadio = form.querySelector(`input[name="label"][value="${label}"]`);
                 if (labelRadio) labelRadio.checked = true;

             } else {
                 // Set defaults for adding new
                 document.getElementById('address-name').value = user.displayName;
                 document.getElementById('address-phone').value = user.profile?.phone || '';
                 document.getElementById('address-default-shipping').checked = !user.profile?.address; // Default if no shipping exists
                 document.getElementById('address-default-billing').checked = !user.profile?.billingAddress; // Default if no billing exists

             }

             showModal('address-modal');
        }

         window.handleSaveAddress = (event) => {
             event.preventDefault();
             const type = document.getElementById('address-type').value; // 'shipping' or 'billing'
             const addressKey = type === 'billing' ? 'billingAddress' : 'address';
             const defaultShipping = document.getElementById('address-default-shipping').checked;
             const defaultBilling = document.getElementById('address-default-billing').checked;
             const label = document.querySelector('input[name="label"]:checked')?.value || '';

             // Construct address string (simple example)
             const street = document.getElementById('address-street').value;
             const area = document.getElementById('address-area').value;
             const city = document.getElementById('address-city').value;
             const region = document.getElementById('address-region').value;
             const fullAddress = `${street}\n${area}, ${city}\n${region}`; // Store with newlines

              if (!state.currentUser.profile) {
                 state.currentUser.profile = {}; // Initialize profile if it doesn't exist
             }

             state.currentUser.profile[addressKey] = fullAddress;
             state.currentUser.profile[`${type}AddressLabel`] = label; // Store label like shippingAddressLabel

             // Handle default flags - ensure only one default of each type
             if (defaultShipping) state.currentUser.profile.defaultShipping = true;
             if (defaultBilling) state.currentUser.profile.defaultBilling = true;
             // In a real app, you might need to unset other defaults if a new one is set

             // Update phone number if it was potentially edited here
             state.currentUser.profile.phone = document.getElementById('address-phone').value;


             showToast('Address saved successfully!');
             hideModal('address-modal');
             renderProfilePage(); // Re-render the profile page to show the updated address
         }


        window.handlePasswordChange = (event) => { event.preventDefault(); showToast('Password updated successfully!'); document.getElementById('password-change-form').reset(); }
        
        function showOrderDetails(orderId) { // Updated for state array
            const order = state.orders.find(o => o.id === orderId);

            if(!order) return; 
            const detailsTitle = document.getElementById('order-details-title'); 
            const detailsContent = document.getElementById('order-details-content'); 
            detailsTitle.textContent = `Details for Order #${orderId.substring(5,11)}`; 
            const itemsHtml = order.items.map(item => `<li>${item.name} (x${item.quantity}) - ৳${(item.price * item.quantity).toFixed(2)}</li>`).join(''); 
            detailsContent.innerHTML = `<div><p><strong>Date:</strong> ${order.date.toLocaleDateString()}</p><p><strong>Status:</strong> ${order.status}</p><p><strong>Total:</strong> ৳${order.total.toFixed(2)}</p><h4 class="font-bold mt-4">Items:</h4><ul class="list-disc pl-5">${itemsHtml}</ul></div>`; 
            showModal('order-details-modal'); 
        }
        window.showOrderDetails = showOrderDetails;

        // --- REMOVED FIREBASE AUTH LISTENER ---
        
        // --- REMOVED FIREBASE DATA LISTENERS ---

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            state.products = mockProducts; // Initialize with mock data
            state.orders = mockOrders;     // Initialize with mock data
            calculateDashboardStats();      // Calculate initial stats
            
            handleNavigation('home');
            updateHeaderUI();
            lucide.createIcons();
            document.getElementById('footer-year').textContent = new Date().getFullYear();
            
            // Assign handlers to window for inline HTML onclicks
            window.handleNavigation = handleNavigation;
            // Ensure other handlers are assigned to window
            window.handleSearch = handleSearch;
            window.handleAddToCart = handleAddToCart;
            window.handleBuyNow = handleBuyNow;
            window.handleRemoveFromCart = handleRemoveFromCart;
            window.handleQuantityChange = handleQuantityChange;
            window.handlePlaceOrder = handlePlaceOrder;
        });

    </script>
</body>
</html>

